# Swift Courier - Package Tracking Flow Documentation

## Overview

The tracking system allows **anyone** to track packages without creating an account, similar to FedEx, USPS, and DHL. Authentication is only required for administrative operations.

## User Flow (Public Tracking)

### 1. User Access `/track` Page
```
User → /app/tracking/page.tsx
```
- No authentication required
- Users enter their 12-character tracking number (e.g., `SC1234567890`)
- Client-side validation ensures format is correct

### 2. Fetch Tracking Data
```
GET /api/tracking/[trackingNumber]
```
- **Public endpoint** - No authentication required
- Returns package details and tracking history
- Response includes:
  - Current status (pending, in_transit, out_for_delivery, delivered)
  - Location information
  - Delivery timeline
  - Sender/recipient details
  - Complete tracking history with events

### 3. Display Results
- Package status with progress indicator
- Real-time location updates (simulated every 30 seconds)
- Full tracking history with timestamps
- Delivery information

## Admin Flow (Update Tracking)

### 1. Authentication Required
```
POST /api/tracking/[trackingNumber]
```
- User must be logged in with valid auth token
- User role must be `admin` or `staff`
- Returns `401` if not authenticated
- Returns `403` if user lacks permission

### 2. CSRF Protection
All state-changing requests require a valid CSRF token:

#### Get CSRF Token
```javascript
const response = await fetch('/api/csrf-token')
const { token } = await response.json()
```

#### Add Tracking Event with CSRF Token
```javascript
const response = await fetch('/api/tracking/SC1234567890', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': csrfToken, // CSRF token in header
  },
  body: JSON.stringify({
    event: {
      status: 'in_transit',
      location: 'Chicago, IL',
      description: 'Package in transit to destination'
    },
    csrfToken: csrfToken, // Also in body for redundancy
  })
})
```

### 3. CSRF Token Details
- **Generated**: `/api/csrf-token` (GET)
- **Validity**: 1 hour from generation
- **Storage**: In-memory (can be upgraded to Redis in production)
- **Validation**: Single-use tokens (deleted after validation)

## Security Measures

### HTTPS Enforcement ✅
```
middleware.ts
```
- Redirects all HTTP requests to HTTPS in production
- Uses `x-forwarded-proto` header to detect protocol
- Permanent redirect (308) to preserve HTTP method

### CSRF Protection ✅
```
lib/csrf.ts + app/api/csrf-token/route.ts
```
- CSRF tokens generated by `generateCSRFToken()`
- Validated by `verifyCSRFToken()` on state-changing requests
- Tokens expire after 1 hour
- Supports both header and body validation

### Authentication ✅
```
app/api/tracking/[trackingNumber]/route.ts (POST)
```
- Auth token required from `auth-token` cookie
- User role check (admin/staff only)
- Returns appropriate error codes:
  - `401`: No/invalid authentication
  - `403`: Insufficient permissions
  - `404`: User/package not found

## API Endpoints

### GET - Track Package (Public)
```
GET /api/tracking/[trackingNumber]
```
- **Auth Required**: No
- **CSRF Required**: No
- **Response**: 
  ```json
  {
    "success": true,
    "data": {
      "trackingNumber": "SC1234567890",
      "status": "in_transit",
      "currentLocation": "Chicago, IL",
      "progress": 65,
      "recipient": { ... },
      "sender": { ... },
      "events": [ ... ],
      "estimatedDelivery": "2024-01-20T18:00:00.000Z",
      "cost": 19.99
    },
    "lastUpdated": "2024-01-19T12:00:00.000Z"
  }
  ```

### POST - Add Tracking Event (Admin)
```
POST /api/tracking/[trackingNumber]
```
- **Auth Required**: Yes (admin/staff)
- **CSRF Required**: Yes
- **Request**:
  ```json
  {
    "csrfToken": "...",
    "event": {
      "status": "in_transit",
      "location": "Chicago, IL",
      "description": "Package in transit"
    }
  }
  ```
- **Response**:
  ```json
  {
    "success": true,
    "message": "Tracking event added successfully"
  }
  ```

### GET - Generate CSRF Token
```
GET /api/csrf-token
```
- **Auth Required**: No
- **Response**:
  ```json
  {
    "success": true,
    "token": "..."
  }
  ```

## Frontend Integration

### React Hook for CSRF Tokens
```typescript
import { useCSRFToken } from '@/hooks/useCSRFToken'

function AdminComponent() {
  const { csrfToken, loading, error } = useCSRFToken()
  
  const handleAddEvent = async (trackingNumber: string) => {
    if (!csrfToken) return
    
    const response = await fetch(`/api/tracking/${trackingNumber}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': csrfToken,
      },
      body: JSON.stringify({
        csrfToken,
        event: { ... }
      })
    })
  }
}
```

### API Client Utility
```typescript
import { apiCall, publicApiCall } from '@/lib/api-client'

// Public tracking lookup
const trackingData = await publicApiCall('/api/tracking/SC1234567890')

// Admin - Add event with CSRF
const result = await apiCall('/api/tracking/SC1234567890', {
  method: 'POST',
  body: { event: { ... } },
  csrfToken: csrfToken,
})
```

## Error Handling

### Public Tracking Errors
| Status | Message | Resolution |
|--------|---------|-----------|
| 400 | Tracking number is required | Enter a tracking number |
| 404 | Package not found | Check tracking number format (SC + 10 digits) |
| 500 | Internal server error | Contact support |

### Admin Operations Errors
| Status | Message | Reason |
|--------|---------|--------|
| 400 | Invalid event data | Missing status, location, or description |
| 401 | No authentication token | Login required |
| 401 | Invalid authentication token | Token expired or tampered |
| 403 | Invalid or missing CSRF token | Refresh CSRF token |
| 403 | Only administrators can add events | User role must be admin/staff |
| 404 | Package not found | Invalid tracking number |
| 500 | Internal server error | Server error |

## Testing

### Test Public Tracking (No Auth)
```bash
curl https://swiftcourier.com/api/tracking/SC1122334455
```

### Test Admin Event Addition (With Auth & CSRF)
```bash
# 1. Get CSRF token
curl https://swiftcourier.com/api/csrf-token

# 2. Add tracking event
curl -X POST https://swiftcourier.com/api/tracking/SC1122334455 \
  -H "Content-Type: application/json" \
  -H "X-CSRF-Token: [token]" \
  -H "Cookie: auth-token=[your_token]" \
  -d '{
    "csrfToken": "[token]",
    "event": {
      "status": "in_transit",
      "location": "Phoenix, AZ",
      "description": "Package in transit"
    }
  }'
```

## Production Checklist

- [ ] HTTPS enforcement enabled (automatic for Vercel/Render)
- [ ] CSRF tokens stored in Redis (not in-memory)
- [ ] JWT secret set in environment variables
- [ ] Database configured for persistent storage
- [ ] Error logging configured (Sentry/LogRocket)
- [ ] Rate limiting added to `/api/csrf-token` endpoint
- [ ] Admin user roles properly configured in database
- [ ] Tracking data backed by real database (not mock data)

## Future Improvements

1. **Email Notifications**: Send tracking updates to email on state change
2. **SMS Alerts**: Text message notifications for delivery
3. **Webhook Integration**: Push events to merchant systems
4. **Real-time WebSocket**: Live updates instead of polling
5. **QR Code Scanning**: Mobile app integration for scanning tracking codes
6. **Signature Capture**: Photo proof of delivery
7. **Route Optimization**: Show estimated route on map
